// VOCH Platform - Prisma Schema
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  username      String   @unique
  passwordHash  String?
  firstName     String
  lastName      String
  avatar        String?
  bio           String?
  dateOfBirth   DateTime?
  phoneNumber   String?
  isVerified    Boolean  @default(false)
  role          Role     @default(USER)
  level         Int      @default(1)
  xp            Int      @default(0)
  badges        Json?    // Array of earned badges
  interests     String[] // Tags for interests
  
  // OAuth fields
  googleId      String?  @unique
  facebookId    String?  @unique
  appleId       String?  @unique
  
  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?
  
  // Relations
  posts         Post[]
  comments      Comment[]
  likes         Like[]
  polls         Poll[]
  pollVotes     PollVote[]
  ngoProfile    NGOProfile?
  fundraisers   Fundraiser[]
  donations     Donation[]
  messages      Message[]
  notifications Notification[]
  followers     Follow[]  @relation("UserFollowers")
  following     Follow[]  @relation("UserFollowing")
  
  @@index([email])
  @@index([username])
}

enum Role {
  USER
  NGO
  ADMIN
  MODERATOR
}

// Post Model
model Post {
  id          String     @id @default(uuid())
  userId      String
  content     String
  mediaUrls   String[]   // Array of image/video URLs
  mediaType   MediaType  @default(IMAGE)
  likesCount  Int        @default(0)
  commentsCount Int      @default(0)
  sharesCount Int        @default(0)
  isPublic    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  // Relations
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments    Comment[]
  likes       Like[]
  
  @@index([userId])
  @@index([createdAt])
}

enum MediaType {
  IMAGE
  VIDEO
  REEL
  STORY
}

// Comment Model  
model Comment {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([postId])
  @@index([userId])
}

// Like Model
model Like {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())
  
  // Relations
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

// Poll Model
model Poll {
  id          String     @id @default(uuid())
  userId      String
  question    String
  description String?
  options     Json       // Array of poll options
  totalVotes  Int        @default(0)
  endsAt      DateTime
  isActive    Boolean    @default(true)
  isAnonymous Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  // Relations
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  votes       PollVote[]
  
  @@index([userId])
  @@index([endsAt])
}

// Poll Vote Model
model PollVote {
  id        String   @id @default(uuid())
  pollId    String
  userId    String
  optionId  String   // Reference to option in Poll.options JSON
  createdAt DateTime @default(now())
  
  // Relations
  poll      Poll     @relation(fields: [pollId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([pollId, userId])
  @@index([pollId])
}

// NGO Profile Model
model NGOProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  orgName         String
  registrationNo  String   @unique
  description     String
  website         String?
  address         String
  city            String
  state           String
  country         String
  causeAreas      String[] // Education, Health, Environment, etc.
  verificationDoc String   // Document URL
  isVerified      Boolean  @default(false)
  verifiedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fundraisers     Fundraiser[]
  
  @@index([userId])
}

// Fundraiser Model
model Fundraiser {
  id          String     @id @default(uuid())
  ngoId       String
  userId      String
  title       String
  description String
  goalAmount  Float
  raisedAmount Float     @default(0)
  currency    String     @default("INR")
  category    String
  images      String[]
  startDate   DateTime   @default(now())
  endDate     DateTime
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  // Relations
  ngoProfile  NGOProfile @relation(fields: [ngoId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  donations   Donation[]
  
  @@index([ngoId])
  @@index([userId])
}

// Donation Model
model Donation {
  id            String     @id @default(uuid())
  fundraiserId  String
  userId        String
  amount        Float
  currency      String     @default("INR")
  paymentId     String     @unique
  paymentStatus String     // SUCCESS, PENDING, FAILED
  isAnonymous   Boolean    @default(false)
  message       String?
  createdAt     DateTime   @default(now())
  
  // Relations
  fundraiser    Fundraiser @relation(fields: [fundraiserId], references: [id], onDelete: Cascade)
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([fundraiserId])
  @@index([userId])
}

// Follow Model
model Follow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  
  // Relations
  follower    User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)
  
  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// Message Model (for E2E encrypted messaging)
model Message {
  id          String   @id @default(uuid())
  senderId    String
  receiverId  String
  encryptedContent String // E2E encrypted message
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  // Relations
  sender      User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  
  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}

// Notification Model
model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?    // Additional data
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([createdAt])
}

enum NotificationType {
  LIKE
  COMMENT
  FOLLOW
  POLL_VOTE
  DONATION
  FUNDRAISER_GOAL
  BADGE_EARNED
  LEVEL_UP
  MESSAGE
}
